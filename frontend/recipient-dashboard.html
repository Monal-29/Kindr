<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipient Dashboard - Kindr</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="dashboard-container">
        <header>
            <h1>Help Request Dashboard</h1>
            <button onclick="logout()" class="btn-logout">Logout</button>
        </header>

        <main>
            <section class="dashboard-content">
                <button onclick="showCreateRequestForm()" class="btn-primary">Create Help Request</button>

                <h2>My Help Requests</h2>
                <div id="requests-container">
                    <!-- Requests will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Create Request Modal -->
    <div id="createModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeCreateModal()">&times;</span>
            <h2>Create Help Request</h2>
            <form id="create-request-form" onsubmit="createHelpRequest(event)">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" rows="5" required></textarea>
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category">
                        <option value="financial">Financial</option>
                        <option value="medical">Medical</option>
                        <option value="education">Education</option>
                        <option value="food">Food</option>
                        <option value="shelter">Shelter</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location">
                </div>
                <div class="form-group">
                    <label for="urgency">Urgency</label>
                    <select id="urgency">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="document">Supporting Document (Optional)</label>
                    <input type="file" id="document" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx">
                </div>
                <div class="form-group">
                    <label for="qr_code">Payment QR Code (Image - Optional)</label>
                    <input type="file" id="qr_code" accept=".png,.jpg,.jpeg">
                </div>
                <button type="submit" class="btn-primary">Submit Request</button>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const token = checkAuth();
            if (!token) return;
            loadMyRequests();
        });

        function showCreateRequestForm() {
            document.getElementById('createModal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('createModal').style.display = 'none';
        }

        async function createHelpRequest(event) {
            event.preventDefault();

            // Check if user is logged in
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Please login first');
                window.location.href = 'login.html';
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Submitting...';
            submitBtn.disabled = true;

            try {
                const fileInput = document.getElementById('document');
                const qrInput = document.getElementById('qr_code');
                const hasFile = (fileInput.files && fileInput.files.length > 0) || (qrInput.files && qrInput.files.length > 0);

                let response;

                const url = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.HELP_REQUESTS.CREATE}`;
                console.log('[Create Request] URL:', url);
                console.log('[Create Request] Has file:', hasFile);

                if (hasFile) {
                    // Use FormData for file upload
                    const formData = new FormData();
                    formData.append('title', document.getElementById('title').value);
                    formData.append('description', document.getElementById('description').value);
                    formData.append('category', document.getElementById('category').value);
                    formData.append('location', document.getElementById('location').value);
                    formData.append('urgency', document.getElementById('urgency').value);
                    if (fileInput.files.length > 0) {
                        formData.append('document', fileInput.files[0]);
                    }
                    if (qrInput.files.length > 0) {
                        formData.append('qr_code', qrInput.files[0]);
                    }

                    console.log('[Create Request] Sending FormData');

                    // Make request with FormData
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                            // Don't set Content-Type - browser will set it with boundary for FormData
                        },
                        body: formData
                    });
                } else {
                    // Use JSON for regular request
                    const data = {
                        title: document.getElementById('title').value,
                        description: document.getElementById('description').value,
                        category: document.getElementById('category').value,
                        location: document.getElementById('location').value,
                        urgency: document.getElementById('urgency').value
                    };

                    console.log('[Create Request] Sending JSON:', data);

                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(data)
                    });
                }

                console.log('[Create Request] Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Server error: ${response.status}` }));
                    throw new Error(errorData.error || 'Failed to create request');
                }

                const result = await response.json();
                alert('Help request created! It will be reviewed by admin.');
                closeCreateModal();
                document.getElementById('create-request-form').reset();
                loadMyRequests();

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            } catch (error) {
                console.error('Create request error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });

                let errorMsg = error.message;
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = 'Cannot connect to server. Please check:\n1. Backend is running on http://127.0.0.1:5000\n2. Check browser console (F12) for details\n3. Try without the file first';
                }

                alert('Failed to create request: ' + errorMsg);

                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function loadMyRequests() {
            try {
                const requests = await apiCall(API_CONFIG.ENDPOINTS.HELP_REQUESTS.GET_MY_REQUESTS);
                const container = document.getElementById('requests-container');

                if (requests.length === 0) {
                    container.innerHTML = '<p>No help requests yet. Create your first request!</p>';
                    return;
                }

                container.innerHTML = requests.map(req => `
                    <div class="request-card">
                        <h3>${req.title}</h3>
                        <p>${req.description}</p>
                        <div class="request-meta">
                            <span class="status status-${req.status}">${req.status}</span>
                            <span class="category">${req.category}</span>
                            <span class="urgency">${req.urgency}</span>
                        </div>
                        <small>Created: ${new Date(req.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load requests:', error);
            }
        }
    </script>
</body>

</html>