<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kindr</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="dashboard-container">
        <header>
            <h1>Admin Dashboard</h1>
            <button onclick="logout()" class="btn-logout">Logout</button>
        </header>

        <main>
            <section class="stats-section">
                <h2>Statistics</h2>
                <div id="stats-container" class="stats-grid">
                    <!-- Stats will be loaded here -->
                </div>
            </section>

            <section class="dashboard-content">
                <h2>Pending Verification Requests</h2>
                <div id="pending-requests-container">
                    <!-- Requests will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const token = checkAuth();
            if (!token) return;

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.userType !== 'admin') {
                alert('Admin access required');
                window.location.href = 'login.html';
                return;
            }

            loadStats();
            loadPendingRequests();
        });

        async function loadStats() {
            try {
                const stats = await apiCall(API_CONFIG.ENDPOINTS.ADMIN.STATS);
                const container = document.getElementById('stats-container');
                container.innerHTML = `
                    <div class="stat-card">
                        <h3>${stats.total_requests}</h3>
                        <p>Total Requests</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.pending_requests}</h3>
                        <p>Pending</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.verified_requests}</h3>
                        <p>Verified</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.total_matches}</h3>
                        <p>Matches</p>
                    </div>
                    <div class="stat-card">
                        <h3>${stats.total_users}</h3>
                        <p>Users</p>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadPendingRequests() {
            try {
                const requests = await apiCall(API_CONFIG.ENDPOINTS.ADMIN.PENDING_REQUESTS);
                const container = document.getElementById('pending-requests-container');

                if (requests.length === 0) {
                    container.innerHTML = '<p>No pending requests.</p>';
                    return;
                }

                container.innerHTML = requests.map(req => `
                    <div class="request-card">
                        <h3>${req.title}</h3>
                        <p>${req.description}</p>
                        <div class="request-meta">
                            <p><strong>Recipient:</strong> ${req.recipient_name} (${req.recipient_email})</p>
                            <p><strong>Category:</strong> ${req.category}</p>
                            <p><strong>Location:</strong> ${req.location || 'N/A'}</p>
                            <p><strong>Urgency:</strong> ${req.urgency}</p>
                            ${req.document_path ? `<p><a href="#" onclick="viewDocument(${req.id}, event)">View Document</a></p>` : '<p>No document uploaded</p>'}
                        </div>
                        <div class="admin-actions">
                            <button onclick="verifyRequest(${req.id}, 'verify')" class="btn-verify">✓ Verify</button>
                            <button onclick="verifyRequest(${req.id}, 'reject')" class="btn-reject">✕ Reject</button>
                        </div>
                        <small>Created: ${new Date(req.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load pending requests:', error);
            }
        }

        async function verifyRequest(requestId, action) {
            if (!confirm(`Are you sure you want to ${action} this request?`)) {
                return;
            }

            try {
                await apiCall(API_CONFIG.ENDPOINTS.ADMIN.VERIFY_REQUEST(requestId), 'POST', { action });
                alert(`Request ${action}ed successfully!`);
                loadPendingRequests();
                loadStats();
            } catch (error) {
                alert('Failed to verify request: ' + error.message);
            }
        }

        async function viewDocument(requestId, event) {
            event.preventDefault();
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.ADMIN.GET_DOCUMENT(requestId)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch document');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');

                // Cleanup after 1 minute
                setTimeout(() => window.URL.revokeObjectURL(url), 60000);
            } catch (error) {
                console.error('Error viewing document:', error);
                alert('Failed to view document');
            }
        }
    </script>
</body>

</html>